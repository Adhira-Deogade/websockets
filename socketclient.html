<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Socket.IO Client</title>
</head>
<body>
    <!-- This is gonna make the cursor location available throughout the webpage -->
    <style>
        :root,body{min-height: 100vh;}
    </style>
    <h1>Socket.IO Example</h1>
     <!-- This script is important for using the websocket protocol -->
      <!-- Gives me Websocket connection called io -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // We are creating a dictionary called cursors
        const cursors = new Map()
        // We are creating a function called getOrCreateCursor
        // which returns the id stored in the cursor dictionary else adds it
        // to the dictionary
        // The dictionary has this data -
        // Key = user_id; Value = new html section with CSS
        const getOrCreateCursor = (id) => {
            let existing = cursors.get(id)
            if (existing) {
                return existing
            }
            console.log("cursor id = ", id)
            const el = document.createElement('div')
            const hash = getHash(id);
            const hue = hash % 360;

            Object.assign(el.style, {
display: 'block',
position: 'fixed',
transform: 'translate(-50%, -50%)',
background: `hsl(${hue}, 70%, 60%)`,
width: '16px',
height: '16px',
transition: '0.3s left, 0.3s right',
clipPath: 'path("M 0 0 L 0 12 L 3 12 L 5 16 L 8 16 L 6 12 L 9 12 Z")',

            })

            // Add user_id and document, html repr to dictionary
            cursors.set(id, el)

            document.body.appendChild(el)

            return el
        }

        const deleteCursor = (id) => {
            let existing = cursors.get(id)
            if (existing) {
                existing.remove()
                cursors.delete(id)
            }

        }


        // This function will create a random color
        // This color will be used to associate with the socket_id
        // To make sure that each socket_id gets a unique color, we will use hashing
        const getHash = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                // Bitwise shift and add for uniform distribution
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
                hash |= 0; // Force to 32-bit integer
            }
            return Math.abs(hash); // Ensure positive value
        };


        // Example usage:
        // socket_color = getRandomHslColor();
        // console.log("Random socket color = ", socket_color); 
        // Output: hsl(275, 100%, 50%)

        const socket = io();
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('cursor-position', (msg) => {
            // const msg = JSON.parse(msg)
            // console.log(msg)
            const cursor = getOrCreateCursor(msg.id);
            Object.assign(cursor.style, {
                left: msg.x + 'px',
                 top: msg.y + 'px'
            })
        });

        socket.on('cursor-disconnect', (msg) => {
            console.log('disconnect', msg)
            // const msg = JSON.parse(msg_string)
            deleteCursor(msg.id)
        });

        document.body.addEventListener("mousemove", (evt) => {
            // console.log("Evt = ", evt);
            socket.send('clientX = ' + evt.clientX);
            socket.send('clientY = ' + evt.clientY);
            socket.emit('cursor-position', {x: evt.clientX, y: evt.clientY})
        })

    </script>
</body>
</html>
